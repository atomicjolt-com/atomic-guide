# Story 1.1: Multi-Tenant D1 Database Foundation Setup

## Status

Approved

## Story

**As a** platform administrator,
**I want** multi-tenant D1 database infrastructure with tenant isolation,
**so that** each institution's learner data is securely separated and the system can support cognitive profiling at scale.

## Acceptance Criteria

1. D1 database binding is configured in wrangler.jsonc with proper naming convention
2. Database schema includes all required tables: learner_profiles, learning_sessions, struggle_events, knowledge_graph, intervention_logs, chat_conversations, chat_messages
3. Multi-tenant isolation is enforced through tenant_id partitioning on all tables
4. Database migration scripts are created and can be run via npm command
5. Basic CRUD operations are implemented for learner_profiles with tenant isolation
6. Unit tests verify tenant isolation cannot be bypassed
7. Performance metrics show D1 queries complete in <10ms for basic operations
8. Fallback to KV storage is implemented for read operations if D1 fails

## Tasks / Subtasks

- [ ] Configure D1 database binding in wrangler.jsonc (AC: 1)
  - [ ] Add D1 database configuration with binding name D1_PRIMARY
  - [ ] Update limits to support 50ms CPU time for cognitive processing
  - [ ] Add new Durable Objects bindings for STRUGGLE_DETECTOR and CHAT_CONVERSATIONS
- [ ] Create database schema file at src/db/schema.sql (AC: 2)
  - [ ] Define learner_profiles table with tenant_id, lti_user_id, cognitive_profile JSON
  - [ ] Define learning_sessions table with foreign key to learner_profiles
  - [ ] Define struggle_events, knowledge_graph, intervention_logs tables
  - [ ] Define chat_conversations and chat_messages tables for AI Guide chat
  - [ ] Add composite indexes on (tenant_id, lti_user_id) for performance
- [ ] Implement database migration system (AC: 4)
  - [ ] Create scripts/setup-d1.js for initial database setup
  - [ ] Add npm script "db:migrate" to package.json
  - [ ] Create src/db/migrations directory structure
  - [ ] Implement migration runner that tracks applied migrations
- [ ] Create data access layer with tenant isolation (AC: 3, 5)
  - [ ] Create src/db/queries.ts with prepared statements
  - [ ] Implement createLearnerProfile with mandatory tenant_id parameter
  - [ ] Implement getLearnerProfile with tenant_id validation
  - [ ] Implement updateLearnerProfile with tenant_id check
  - [ ] Add query builder helpers that always include tenant_id
- [ ] Implement KV fallback layer (AC: 8)
  - [ ] Create src/services/StorageFallback.ts service
  - [ ] Implement read-through cache pattern for learner profiles
  - [ ] Add circuit breaker pattern for D1 failures
  - [ ] Log fallback usage to metrics table
- [ ] Create unit tests for data isolation (AC: 6)
  - [ ] Test that queries without tenant_id fail
  - [ ] Test cross-tenant data access is blocked
  - [ ] Test fallback activates on D1 timeout
  - [ ] Use learnerProfileFactory from test utilities
- [ ] Add performance monitoring (AC: 7)
  - [ ] Create performance test suite for D1 operations
  - [ ] Add timing metrics to all database queries
  - [ ] Verify sub-10ms performance for basic CRUD
  - [ ] Add alerts for queries exceeding 10ms threshold

## Dev Notes

### Database Schema Details

[Source: architecture/data-models-and-schema-changes.md]

**Learner Profile Model:**

- `id`: UUID - Unique identifier
- `tenant_id`: UUID - Institution identifier (D1 partitioning key)
- `lti_user_id`: String - Maps to LTI sub claim from JWT
- `cognitive_profile`: JSON - Memory patterns, learning velocity
- `privacy_settings`: JSON - Consent flags, data sharing preferences
- `created_at`: Timestamp
- `updated_at`: Timestamp

**Learning Session Model:**

- `id`: UUID - Session identifier
- `learner_id`: UUID - Foreign key to LearnerProfile
- `course_context`: String - LTI context_id
- `session_start`: Timestamp - Launch time
- `behavioral_signals`: JSON - Hover times, scroll patterns
- `interventions_delivered`: Array

**Knowledge Graph Model:**

- `concept_id`: UUID
- `tenant_id`: UUID - Institution scope
- `concept_name`: String
- `dependencies`: Array<UUID> - Prerequisite concepts
- `course_contexts`: Array - LTI contexts using concept

### Infrastructure Configuration

[Source: architecture/infrastructure-and-deployment-integration.md]

**Wrangler.jsonc updates required:**

```jsonc
{
  // NEW: D1 database bindings (per tenant)
  "d1_databases": [
    {
      "binding": "D1_PRIMARY",
      "database_name": "atomic-guide-primary",
      "database_id": "uuid-here",
    },
  ],

  // NEW: Increased limits for cognitive processing
  "limits": {
    "cpu_ms": 50, // Increased from default 10ms
  },

  // Existing Durable Objects extended
  "durable_objects": {
    "bindings": [
      {
        "name": "OIDC_STATE",
        "class_name": "OIDCStateDurableObject",
      },
      {
        "name": "STRUGGLE_DETECTOR", // NEW
        "class_name": "StruggleDetectorDO",
      },
      {
        "name": "CHAT_CONVERSATIONS", // NEW
        "class_name": "ChatConversationDO",
      },
    ],
  },
}
```

### File Locations

[Source: architecture/source-tree-integration.md]

- Database schema: `src/db/schema.sql`
- Migration scripts: `src/db/migrations/`
- Query utilities: `src/db/queries.ts`
- Setup script: `scripts/setup-d1.js`
- Fallback service: `src/services/StorageFallback.ts`
- Test files: `tests/db/` (colocated pattern)

### Technical Constraints

[Source: architecture/infrastructure-and-deployment-integration.md]

- D1 queries must complete in <10ms for production gate
- CPU limit is 50ms maximum for all operations
- Hybrid storage strategy: critical configs stay in KV, learner data in D1
- Implement comprehensive metrics before production deployment
- Daily D1 exports to R2 bucket required for disaster recovery

### Testing Standards

[Source: architecture/testing-strategy.md]

- Test framework: Vitest with @cloudflare/vitest-pool-workers
- Test files colocated with source (\*.test.ts pattern)
- Coverage target: 80% for business logic
- Use learnerProfileFactory for test data generation
- Integration tests required for D1 operations

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-21 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
