# Story 3.2: AI-Powered Assessment Deep Linking Integration

## Status

**Draft**

## Story

**As an** instructor using Atomic Guide in Canvas,
**I want** to embed AI-powered conversational assessment checkpoints directly into Canvas assignments through deep linking,
**so that** students can receive contextual, real-time comprehension feedback while I gain learning insights without leaving the LMS environment.

## Acceptance Criteria

1. System implements LTI 1.3 Deep Linking 2.0 protocol for seamless Canvas assignment integration (FR12)
2. Instructor can launch assessment builder from Canvas assignment creation workflow using deep linking selector
3. Assessment builder provides intuitive UI for configuring AI-guided conversational assessments
4. System generates assessment configurations with content awareness from Story 3.1's extracted LMS content
5. Deep link content items include proper metadata (title, description, icon, custom parameters) for Canvas display
6. Assessment links preserve context including course ID, module position, and content references
7. Students can launch assessments directly from Canvas assignments without additional authentication
8. AI chat interface activates automatically when assessment is launched, providing contextual guidance
9. Assessment responses leverage extracted LMS content for contextually relevant feedback
10. System tracks assessment attempts and maintains conversation history per student per assessment
11. Grades automatically sync back to Canvas gradebook via LTI Assignment and Grade Services (AGS)
12. Instructor dashboard displays aggregate assessment analytics and common struggle points
13. Deep links support both formative (practice) and summative (graded) assessment types
14. System handles deep link errors gracefully with clear user feedback
15. Assessment configurations are stored securely with tenant isolation in D1 database
16. Deep link creation respects instructor permissions and course enrollment status
17. System provides preview mode for instructors to test assessments before student access
18. Assessment builder includes AI assistance for generating contextually appropriate questions
19. Deep links maintain compatibility across Canvas desktop and mobile applications
20. System implements rate limiting to prevent assessment deep link abuse

## Tasks / Subtasks

- [ ] Implement LTI Deep Linking 2.0 handler (AC: 1, 14)
  - [ ] Create src/api/handlers/deepLinking.ts for server-side deep link processing
  - [ ] Implement JWT signing for deep link content items
  - [ ] Add validation for deep link platform requests
  - [ ] Create error handling for malformed deep link requests
  - [ ] Implement rate limiting for deep link creation

- [ ] Build assessment builder UI component (AC: 2, 3, 18)
  - [ ] Create client/components/assessment/AssessmentBuilder.tsx with form interface
  - [ ] Implement assessment type selector (formative vs summative)
  - [ ] Add AI question generation interface with content context
  - [ ] Create rubric builder for assessment criteria
  - [ ] Build preview component for instructor testing

- [ ] Extend deep linking service for assessments (AC: 4, 5, 6)
  - [ ] Enhance client/services/assessmentDeepLink.ts with content awareness
  - [ ] Integrate with ContentAnalyzer from Story 3.1 for context
  - [ ] Add course and module metadata to deep link parameters
  - [ ] Implement icon and thumbnail generation for Canvas display
  - [ ] Create custom parameter encoding for assessment configs

- [ ] Create assessment storage schema (AC: 15, 10)
  - [ ] Design assessment_configs table in D1 database
  - [ ] Add assessment_attempts table for tracking student progress
  - [ ] Create assessment_conversations table for chat history
  - [ ] Implement tenant isolation for multi-institution support
  - [ ] Add indexes for efficient retrieval by course/student

- [ ] Implement assessment launch handler (AC: 7, 8, 9)
  - [ ] Create src/api/handlers/assessmentLaunch.ts for LTI launch processing
  - [ ] Verify student enrollment and assessment access permissions
  - [ ] Initialize AI chat with assessment context and LMS content
  - [ ] Load previous attempts and conversation history if exists
  - [ ] Set up WebSocket for real-time chat during assessment

- [ ] Build grade passback integration (AC: 11)
  - [ ] Implement LTI AGS score submission in src/services/gradePassback.ts
  - [ ] Create grade calculation logic based on assessment rubric
  - [ ] Add retry mechanism for failed grade submissions
  - [ ] Implement grade status tracking and error recovery
  - [ ] Support both percentage and points-based grading

- [ ] Create instructor analytics dashboard (AC: 12)
  - [ ] Build client/components/dashboard/AssessmentAnalytics.tsx
  - [ ] Implement aggregate performance visualization
  - [ ] Add struggle point identification from chat patterns
  - [ ] Create export functionality for assessment data
  - [ ] Build real-time updates for ongoing assessments

- [ ] Implement assessment type handling (AC: 13, 17)
  - [ ] Create different flows for formative vs summative assessments
  - [ ] Add attempt limiting for summative assessments
  - [ ] Implement practice mode with unlimited attempts
  - [ ] Build instructor preview mode with sample responses
  - [ ] Add time limits and availability windows

- [ ] Add permission and enrollment validation (AC: 16)
  - [ ] Verify instructor role before allowing deep link creation
  - [ ] Check course enrollment for assessment access
  - [ ] Implement course-level permission inheritance
  - [ ] Add institution-level feature flags
  - [ ] Create audit logging for assessment creation

- [ ] Ensure mobile compatibility (AC: 19)
  - [ ] Test deep links in Canvas mobile apps (iOS/Android)
  - [ ] Optimize assessment UI for mobile viewports
  - [ ] Ensure touch-friendly interaction patterns
  - [ ] Implement responsive chat interface
  - [ ] Add offline detection and recovery

- [ ] Create comprehensive testing suite (AC: 14, 20)
  - [ ] Write unit tests for deep linking JWT signing
  - [ ] Create integration tests for full deep link flow
  - [ ] Add load tests for concurrent assessment creation
  - [ ] Implement security tests for permission validation
  - [ ] Build end-to-end tests with Canvas test instance

## Dev Notes

### Previous Story Insights

Story 3.1 successfully implemented LMS content extraction via postMessage API, creating a foundation for content-aware assessments. The ContentAnalyzer service can identify key concepts, learning objectives, and assessment opportunities from LMS pages. This content awareness should be leveraged to generate contextually relevant assessment questions and provide targeted feedback based on the actual course material students are reading.

### Technical Architecture

**Deep Linking Flow:**
```
Canvas Assignment Creation → Deep Link Request → 
Assessment Builder UI → Configuration Save → 
JWT Signed Content Item → Return to Canvas → 
Student Launch → Assessment with AI Chat
```

### Data Models

**Assessment Configuration Schema:**
[Source: client/schemas/assessment.schema.ts]
```typescript
interface AssessmentConfig {
  assessmentType: 'formative' | 'summative' | 'diagnostic';
  masteryThreshold: number; // 0-100
  gradingSchema: {
    type: 'points' | 'percentage' | 'rubric';
    maxScore: number;
    passingScore: number;
  };
  rubric: {
    criteria: RubricCriteria[];
  };
  questions: AssessmentQuestion[];
  aiGuidance: {
    assessmentFocus: string;
    keyConceptsToTest: string[];
    allowedAttempts: number;
  };
  title: string;
  description?: string;
  timeLimit?: number;
  shuffleQuestions: boolean;
  showFeedback: boolean;
}
```

**Database Schema:**
```sql
CREATE TABLE assessment_configs (
  id TEXT PRIMARY KEY,
  tenant_id TEXT NOT NULL,
  course_id TEXT NOT NULL,
  created_by TEXT NOT NULL,
  config JSON NOT NULL,
  content_context JSON, -- From Story 3.1 content extraction
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);

CREATE TABLE assessment_attempts (
  id TEXT PRIMARY KEY,
  assessment_id TEXT NOT NULL,
  student_id TEXT NOT NULL,
  attempt_number INTEGER NOT NULL,
  score REAL,
  status TEXT NOT NULL, -- 'in_progress', 'completed', 'abandoned'
  started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  completed_at TIMESTAMP,
  chat_conversation_id TEXT,
  FOREIGN KEY (assessment_id) REFERENCES assessment_configs(id),
  UNIQUE(assessment_id, student_id, attempt_number)
);

CREATE TABLE assessment_conversations (
  id TEXT PRIMARY KEY,
  attempt_id TEXT NOT NULL,
  messages JSON NOT NULL, -- Array of chat messages
  ai_feedback JSON, -- Structured feedback from AI
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (attempt_id) REFERENCES assessment_attempts(id)
);
```

### API Specifications

**Deep Link Creation API:**
[Source: existing client/services/assessmentDeepLink.ts]
```typescript
// POST /lti/deep_link/assessment
Request: {
  config: AssessmentConfig;
  contentContext?: { // From Story 3.1
    pageUrl: string;
    keyConcepts: string[];
    learningObjectives: string[];
  };
}
Response: {
  jwt: string; // Signed deep link JWT
  contentItems: LtiResourceLink[];
}
```

**Assessment Launch API:**
```typescript
// POST /lti/launch/assessment
Request: {
  // Standard LTI launch parameters
  custom: {
    assessment_id: string;
    attempt_number?: number;
  };
}
Response: {
  assessmentConfig: AssessmentConfig;
  previousAttempts: AssessmentAttempt[];
  chatContext: {
    conversationId: string;
    wsEndpoint: string;
    contentAwareness: boolean;
  };
}
```

**Grade Passback API:**
```typescript
// POST /api/assessment/grade
Request: {
  attemptId: string;
  score: number;
  feedback: string;
}
Response: {
  success: boolean;
  ltiGradeResponse?: {
    scoreGiven: number;
    scoreMaximum: number;
    activityProgress: string;
    gradingProgress: string;
  };
}
```

### Component Architecture

**Client Components:**
- `client/components/assessment/AssessmentBuilder.tsx` - Main builder interface
- `client/components/assessment/QuestionEditor.tsx` - Question creation/editing
- `client/components/assessment/RubricBuilder.tsx` - Rubric configuration
- `client/components/assessment/AIQuestionGenerator.tsx` - AI-assisted question generation
- `client/components/assessment/AssessmentPreview.tsx` - Instructor preview mode
- `client/components/assessment/AssessmentRunner.tsx` - Student assessment interface

**Server Services:**
- `src/services/deepLinkingService.ts` - Deep link JWT signing and validation
- `src/services/assessmentService.ts` - Assessment CRUD operations
- `src/services/gradePassback.ts` - LTI AGS integration
- `src/services/assessmentAnalytics.ts` - Analytics aggregation

### File Locations

**New files to create:**
- `src/api/handlers/deepLinking.ts` - Deep linking request handler
- `src/api/handlers/assessmentLaunch.ts` - Assessment launch handler
- `src/services/deepLinkingService.ts` - Server-side deep linking logic
- `src/services/assessmentService.ts` - Assessment business logic
- `src/services/gradePassback.ts` - AGS grade submission
- `client/components/assessment/AssessmentBuilder.tsx` - Builder UI
- `client/components/assessment/QuestionEditor.tsx` - Question editing
- `client/components/assessment/RubricBuilder.tsx` - Rubric creation
- `client/components/dashboard/AssessmentAnalytics.tsx` - Analytics dashboard
- `migrations/003_assessment_tables.sql` - Database migration

**Files to modify:**
- `src/index.ts` - Add deep linking and assessment routes
- `src/db/schema.sql` - Add assessment tables
- `client/app.tsx` - Handle assessment launch context
- `client/services/assessmentDeepLink.ts` - Enhance with content awareness
- `wrangler.jsonc` - Ensure D1 bindings for assessment storage

### Technical Constraints

- Deep link JWT signing must complete within 1 second
- Assessment configurations limited to 100KB to fit in custom parameters
- Grade passback retry limit of 3 attempts with exponential backoff
- Maximum 100 questions per assessment for performance
- Chat conversation history limited to last 50 messages per attempt
- Canvas mobile app compatibility requires responsive design <768px
- Assessment preview mode must not affect grade calculations
- Deep link creation rate limited to 10 per minute per instructor

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

**Test Framework:** Vitest with React Testing Library
**Test Location:** Tests colocated with source files (*.test.ts, *.test.tsx)
**Coverage Target:** 80% for business logic, 60% for UI components

**Required Test Scenarios:**
- Deep link JWT signing and validation
- Assessment configuration validation with Zod schemas
- Grade passback with AGS endpoints
- Permission validation for instructors and students
- Canvas mobile app deep link compatibility
- Concurrent assessment attempt handling
- Content context integration from Story 3.1
- Error recovery for failed grade submissions
- Rate limiting for deep link creation
- Database transaction integrity for assessments

## Change Log

| Date       | Version | Description                                          | Author             |
| ---------- | ------- | ---------------------------------------------------- | ------------------ |
| 2025-08-29 | 1.0     | Initial story creation for deep linking assessment  | Bob (Scrum Master) |