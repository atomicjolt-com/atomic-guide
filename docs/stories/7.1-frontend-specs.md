# Story 7.1: Canvas postMessage Integration - Frontend Specifications

## Overview

This document outlines the front-end specifications for implementing Canvas postMessage integration that enables real-time content extraction and contextual awareness. While Story 7.1 is primarily a backend integration story, the client-side components provide essential user feedback, error handling, and responsive Canvas integration status indicators.

## Component Architecture

### 1. CanvasContextProvider (Primary Component)

**Location:** `client/components/canvas-integration/CanvasContextProvider.tsx`

**Purpose:** Top-level context provider that maintains Canvas page awareness and integration status throughout the application.

```typescript
interface CanvasContextState {
  // Connection Status
  isConnected: boolean;
  connectionHealth: 'good' | 'degraded' | 'poor' | 'disconnected';
  canvasOrigin: string | null;

  // Content Awareness
  currentContent: CanvasPageContent | null;
  contentExtractionStatus: 'idle' | 'extracting' | 'success' | 'error';

  // Integration Metrics
  signalsPerMinute: number;
  lastContentUpdate: Date | null;
  errorCount: number;

  // Feature Availability
  postMessageSupported: boolean;
  contentExtractionAvailable: boolean;
  mobileCanvasDetected: boolean;
}

interface CanvasContextActions {
  // Connection Management
  initializeConnection: () => Promise<boolean>;
  reconnect: () => Promise<boolean>;

  // Content Operations
  extractCurrentContent: () => Promise<CanvasPageContent | null>;
  refreshContentContext: () => Promise<void>;

  // Error Recovery
  clearErrors: () => void;
  retryFailedOperations: () => Promise<void>;
}
```

**Key Features:**
- Integrates with existing `useCanvasPostMessage` hook
- Provides Canvas integration status to all child components
- Handles automatic reconnection and error recovery
- Maintains real-time content awareness state
- Supports mobile Canvas app detection and fallbacks

### 2. CanvasIntegrationStatusIndicator

**Location:** `client/components/canvas-integration/CanvasIntegrationStatusIndicator.tsx`

**Purpose:** Visual indicator showing Canvas integration status with appropriate user feedback.

```typescript
interface StatusIndicatorProps {
  position?: 'top-right' | 'bottom-right' | 'header' | 'inline';
  showDetails?: boolean;
  autoHide?: boolean;
  autoHideDelay?: number;
}

interface StatusDisplay {
  icon: ReactElement;
  color: 'green' | 'yellow' | 'red' | 'gray';
  message: string;
  details?: string;
  actionButton?: {
    label: string;
    action: () => void;
  };
}
```

**Visual States:**
- **Connected (Green):** Canvas integration active and healthy
- **Degraded (Yellow):** Partial functionality, some features limited
- **Error (Red):** Integration failed, fallback mode active
- **Disconnected (Gray):** No Canvas connection detected

**User Interactions:**
- Click to expand details panel
- Retry button for connection issues
- Help link to Canvas integration troubleshooting
- Dismiss button for non-critical notifications

### 3. CanvasContentAwarenessDisplay

**Location:** `client/components/canvas-integration/CanvasContentAwarenessDisplay.tsx`

**Purpose:** Shows current Canvas page context and content extraction status to users.

```typescript
interface ContentAwarenessProps {
  showInChat?: boolean;
  showInDashboard?: boolean;
  compactMode?: boolean;
  real-timeUpdates?: boolean;
}

interface ContentDisplayData {
  pageType: 'assignment' | 'quiz' | 'discussion' | 'page' | 'module' | 'unknown';
  title: string;
  extractionStatus: 'current' | 'stale' | 'extracting' | 'failed';
  lastUpdated: Date;
  confidenceLevel: number; // 0-1 scale
}
```

**Display Components:**
- **Current Page Badge:** Shows detected Canvas page type with icon
- **Content Freshness Indicator:** Visual indicator of content extraction recency
- **Extraction Confidence:** Shows reliability of content detection
- **Context Summary:** Brief description of detected content for AI context

### 4. CanvasErrorBoundary and Fallback UI

**Location:** `client/components/canvas-integration/CanvasErrorBoundary.tsx`

**Purpose:** Graceful error handling with user-friendly fallback interfaces when Canvas integration fails.

```typescript
interface CanvasErrorBoundaryProps {
  children: ReactNode;
  fallbackComponent?: ComponentType<CanvasErrorFallbackProps>;
  onError?: (error: Error, errorInfo: ErrorInfo) => void;
  showRetryButton?: boolean;
  showErrorDetails?: boolean;
}

interface CanvasErrorFallbackProps {
  error: Error;
  resetError: () => void;
  canvasSupported: boolean;
  alternativeActions: AlternativeAction[];
}
```

**Fallback UI Features:**
- Clear explanation of Canvas integration status
- Alternative interaction methods when postMessage fails
- Retry mechanism with exponential backoff
- Links to manual content sharing options
- Graceful degradation messaging

### 5. Mobile Canvas Handler

**Location:** `client/components/canvas-integration/MobileCanvasHandler.tsx`

**Purpose:** Responsive handling for Canvas mobile app and mobile browser limitations.

```typescript
interface MobileCanvasState {
  isMobileCanvas: boolean;
  postMessageSupported: boolean;
  limitedFunctionality: string[];
  recommendedActions: string[];
}

interface MobileAdaptations {
  // UI Adaptations
  touchOptimized: boolean;
  reducedAnimations: boolean;
  simplifiedInterface: boolean;

  // Functionality Adaptations
  fallbackContentExtraction: boolean;
  manualContextSharing: boolean;
  offlineCapability: boolean;
}
```

**Mobile-Specific Features:**
- Detects Canvas mobile app vs mobile browser
- Adapts UI for touch interactions
- Provides fallback options when postMessage is limited
- Optimizes performance for mobile devices
- Handles orientation changes and viewport adjustments

## State Management Approach

### Context Architecture

The Canvas integration uses React Context API with the following hierarchy:

```
<LtiLaunchCheck>                    // Existing LTI wrapper (DO NOT MODIFY)
  <Provider store={store}>          // Existing Redux store
    <CanvasContextProvider>         // NEW: Canvas integration context
      <CrossCourseContextProvider>  // Existing cross-course context
        <App>                       // Main application
```

### State Flow Diagram

```
Canvas Page Event
       ‚Üì
useCanvasPostMessage Hook
       ‚Üì
CanvasContextProvider State Update
       ‚Üì
Context Consumers Re-render
       ‚Üì
UI Components Update
```

### Integration with Existing Systems

**Chat System Integration:**
```typescript
// Enhanced chat context with Canvas awareness
const ChatWithCanvasContext = () => {
  const { currentContent, isConnected } = useCanvasContext();
  const { sendMessage } = useChat();

  const sendCanvasAwareMessage = useCallback((message: string) => {
    const contextualMessage = {
      text: message,
      canvasContext: currentContent,
      integrationStatus: isConnected ? 'active' : 'fallback'
    };
    return sendMessage(contextualMessage);
  }, [currentContent, isConnected, sendMessage]);

  return (
    <div>
      <CanvasContentAwarenessDisplay showInChat />
      <ChatInterface sendMessage={sendCanvasAwareMessage} />
    </div>
  );
};
```

**Analytics Dashboard Integration:**
```typescript
// Dashboard with Canvas integration metrics
const DashboardWithCanvasMetrics = () => {
  const { signalsPerMinute, errorCount, connectionHealth } = useCanvasContext();

  return (
    <div>
      <CanvasIntegrationStatusIndicator position="header" />
      <CanvasMetricsDashboard
        metrics={{ signalsPerMinute, errorCount, connectionHealth }}
      />
      <ExistingAnalyticsDashboard />
    </div>
  );
};
```

## User Interaction Flows

### 1. Initial Canvas Integration Setup

```
User opens Atomic Guide in Canvas
       ‚Üì
CanvasContextProvider initializes
       ‚Üì
Connection attempt to Canvas postMessage API
       ‚Üì
‚îå‚îÄ Success: Show "Canvas Connected" indicator
‚îÇ  ‚îî‚îÄ Begin content extraction
‚îî‚îÄ Failure: Show fallback UI with retry option
```

### 2. Real-Time Content Extraction

```
User navigates to new Canvas page
       ‚Üì
Canvas postMessage sends page change event
       ‚Üì
CanvasContextProvider updates currentContent
       ‚Üì
CanvasContentAwarenessDisplay updates
       ‚Üì
Chat context enriched with new page content
```

### 3. Error Recovery Flow

```
Canvas integration error detected
       ‚Üì
CanvasErrorBoundary catches error
       ‚Üì
Show user-friendly error message
       ‚Üì
Provide retry button and alternative actions
       ‚Üì
‚îå‚îÄ Retry successful: Resume normal operation
‚îî‚îÄ Retry failed: Switch to fallback mode
```

### 4. Mobile Canvas Adaptation

```
Mobile Canvas app detected
       ‚Üì
MobileCanvasHandler evaluates capabilities
       ‚Üì
‚îå‚îÄ Full support: Normal operation with touch optimizations
‚îú‚îÄ Limited support: Show available features + limitations
‚îî‚îÄ No support: Fallback to manual context sharing
```

## Visual Feedback for Canvas Integration Status

### Status Indicator Design

**Connected State:**
- **Icon:** Green circle with checkmark
- **Message:** "Canvas Connected"
- **Details:** "Real-time content awareness active"
- **Actions:** None required

**Degraded State:**
- **Icon:** Yellow triangle with exclamation
- **Message:** "Limited Canvas Integration"
- **Details:** "Some features may be unavailable"
- **Actions:** "Learn More" button

**Error State:**
- **Icon:** Red circle with X
- **Message:** "Canvas Integration Error"
- **Details:** Specific error description
- **Actions:** "Retry" and "Use Fallback" buttons

**Mobile Limitations:**
- **Icon:** Blue info circle
- **Message:** "Mobile Canvas Mode"
- **Details:** "Touch-optimized interface active"
- **Actions:** "View Limitations" button

### Content Awareness Visual Cues

**Current Page Indicator:**
```typescript
const PageTypeIcon = ({ pageType }: { pageType: string }) => {
  const icons = {
    assignment: "üìù",
    quiz: "‚ùì",
    discussion: "üí¨",
    page: "üìÑ",
    module: "üìö",
    unknown: "‚ùî"
  };

  return <span className="page-type-icon">{icons[pageType] || icons.unknown}</span>;
};
```

**Extraction Freshness Indicator:**
```typescript
const FreshnessIndicator = ({ lastUpdated }: { lastUpdated: Date }) => {
  const secondsAgo = (Date.now() - lastUpdated.getTime()) / 1000;

  const status = secondsAgo < 30 ? 'fresh' :
                 secondsAgo < 300 ? 'recent' : 'stale';

  const colors = {
    fresh: 'text-green-500',
    recent: 'text-yellow-500',
    stale: 'text-red-500'
  };

  return (
    <div className={`freshness-indicator ${colors[status]}`}>
      Updated {formatTimeAgo(lastUpdated)}
    </div>
  );
};
```

## Error States and Recovery UX

### Error Classification

**Critical Errors (Red Alert):**
- Canvas origin validation failed
- HMAC signature verification failed
- Complete postMessage communication failure

**Warning Errors (Yellow Alert):**
- Content extraction partially failed
- Rate limiting activated
- Canvas API temporarily unavailable

**Info Notifications (Blue Alert):**
- Mobile Canvas limitations detected
- Fallback mode activated
- Feature temporarily disabled

### Recovery Mechanisms

**Automatic Recovery:**
- Exponential backoff for connection retries
- Automatic fallback to DOM extraction
- Silent recovery when connection restores

**User-Initiated Recovery:**
- Manual retry button with loading state
- "Reset Canvas Connection" action
- "Switch to Manual Mode" option

**Graceful Degradation:**
- Disable real-time features while maintaining core functionality
- Show clear messaging about reduced capabilities
- Provide alternative interaction methods

## Mobile/Responsive Considerations

### Canvas Mobile App Support

**Detection Logic:**
```typescript
const detectMobileCanvas = (): MobileCanvasInfo => {
  const userAgent = navigator.userAgent;
  const isCanvasApp = /Canvas/.test(userAgent);
  const isMobileBrowser = /Mobile|Android|iPhone|iPad/.test(userAgent);

  return {
    isCanvasApp,
    isMobileBrowser,
    postMessageSupport: isCanvasApp ? 'limited' : 'full',
    recommendedMode: isCanvasApp ? 'touch-optimized' : 'standard'
  };
};
```

**Mobile UI Adaptations:**
- Larger touch targets (minimum 44px)
- Simplified navigation with tab-based interface
- Reduced animation and transition effects
- Optimized loading states for slower connections
- Swipe gestures for common actions

**Responsive Breakpoints:**
```css
/* Mobile-first responsive design */
.canvas-integration-status {
  /* Mobile: Compact mode */
  @media (max-width: 768px) {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }

  /* Tablet: Side panel */
  @media (min-width: 769px) and (max-width: 1024px) {
    position: absolute;
    top: 20px;
    right: 20px;
  }

  /* Desktop: Header integration */
  @media (min-width: 1025px) {
    position: relative;
    display: inline-flex;
  }
}
```

### Performance Optimizations for Mobile

**Lazy Loading:**
- Defer non-critical Canvas integration components
- Load full feature set only when needed
- Use React.lazy() for heavy components

**Memory Management:**
- Limit stored content history on mobile
- Clear old behavioral signals more aggressively
- Use WeakMap for temporary references

**Network Optimization:**
- Batch Canvas postMessage calls
- Implement request debouncing
- Use compression for large content payloads

## Accessibility Requirements

### WCAG 2.1 AA Compliance

**Keyboard Navigation:**
- All Canvas integration controls accessible via keyboard
- Clear focus indicators on interactive elements
- Logical tab order through Canvas status indicators

**Screen Reader Support:**
```typescript
// ARIA labels for Canvas integration status
const CanvasStatusLabel = ({ status }: { status: string }) => (
  <div
    role="status"
    aria-live="polite"
    aria-label={`Canvas integration status: ${status}`}
  >
    <span aria-hidden="true">{getStatusIcon(status)}</span>
    <span className="sr-only">Canvas integration is {status}</span>
  </div>
);
```

**Visual Accessibility:**
- High contrast mode support for status indicators
- Color-blind friendly status colors
- Minimum 4.5:1 contrast ratio for all text
- Scalable icons that work at 200% zoom

**Motion and Animation:**
- Respect `prefers-reduced-motion` user preference
- Provide static alternatives to animated indicators
- Limit auto-updating content frequency

### Assistive Technology Integration

**Voice Control Support:**
- Voice commands for retry actions
- Spoken status updates when integration changes
- Voice-accessible fallback options

**Switch Navigation:**
- Single-switch operation for error recovery
- Multiple switch support for complex interactions
- Switch-accessible alternative to postMessage features

## Testing Strategy

### Component Testing

**Unit Tests:**
```typescript
describe('CanvasContextProvider', () => {
  it('should initialize with disconnected state', () => {
    const { result } = renderHook(() => useCanvasContext(), {
      wrapper: CanvasContextProvider
    });

    expect(result.current.isConnected).toBe(false);
    expect(result.current.connectionHealth).toBe('disconnected');
  });

  it('should handle Canvas connection success', async () => {
    // Mock successful Canvas postMessage
    const { result } = renderHook(() => useCanvasContext(), {
      wrapper: CanvasContextProvider
    });

    await act(async () => {
      await result.current.initializeConnection();
    });

    expect(result.current.isConnected).toBe(true);
    expect(result.current.connectionHealth).toBe('good');
  });
});
```

**Integration Tests:**
```typescript
describe('Canvas Integration UI Flow', () => {
  it('should show appropriate status when Canvas connection fails', async () => {
    render(
      <CanvasContextProvider>
        <CanvasIntegrationStatusIndicator />
      </CanvasContextProvider>
    );

    // Simulate connection failure
    fireEvent.click(screen.getByText('Retry Connection'));

    await waitFor(() => {
      expect(screen.getByText('Canvas Integration Error')).toBeInTheDocument();
      expect(screen.getByText('Use Fallback')).toBeInTheDocument();
    });
  });
});
```

### Visual Testing

**Storybook Stories:**
```typescript
export default {
  title: 'Canvas Integration/Status Indicator',
  component: CanvasIntegrationStatusIndicator,
} as Meta;

export const Connected: Story = {
  args: {
    status: 'connected',
    showDetails: true
  }
};

export const MobileLimited: Story = {
  args: {
    status: 'mobile-limited',
    mobileAdaptations: ['touch-optimized', 'reduced-functionality']
  }
};
```

**Cross-Browser Testing:**
- Chrome, Firefox, Safari, Edge on desktop
- Safari Mobile, Chrome Mobile on iOS/Android
- Canvas mobile app testing (when available)
- Internet Explorer 11 fallback behavior

### Accessibility Testing

**Automated Testing:**
```typescript
import { axe, toHaveNoViolations } from 'jest-axe';

expect.extend(toHaveNoViolations);

describe('Canvas Integration Accessibility', () => {
  it('should have no accessibility violations', async () => {
    const { container } = render(
      <CanvasContextProvider>
        <CanvasIntegrationStatusIndicator />
      </CanvasContextProvider>
    );

    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });
});
```

**Manual Testing Checklist:**
- [ ] Screen reader navigation flows
- [ ] Keyboard-only interaction completion
- [ ] High contrast mode visibility
- [ ] Voice control command recognition
- [ ] Switch navigation functionality

## Performance Requirements

### Loading Performance

**Initial Load:**
- Canvas integration components < 50KB compressed
- First Canvas connection attempt < 2 seconds
- Fallback UI ready < 500ms if connection fails

**Runtime Performance:**
- Canvas status updates < 100ms
- Content extraction feedback < 200ms
- Error recovery UI < 150ms
- Memory usage < 10MB additional overhead

**Mobile Performance:**
- Touch response time < 16ms (60fps)
- Canvas app integration < 1 second
- Fallback mode transition < 300ms

### Monitoring and Metrics

**Performance Metrics to Track:**
```typescript
interface CanvasIntegrationMetrics {
  // Connection Performance
  connectionAttempts: number;
  connectionSuccessRate: number;
  averageConnectionTime: number;

  // Content Extraction Performance
  contentExtractionAttempts: number;
  contentExtractionSuccessRate: number;
  averageExtractionTime: number;

  // User Experience Metrics
  errorRecoveryAttempts: number;
  fallbackModeUsage: number;
  mobileUserPercentage: number;

  // Accessibility Metrics
  keyboardNavigationUsage: number;
  screenReaderUsage: number;
  voiceControlUsage: number;
}
```

## Implementation Priority

### Phase 1: Core Components (Week 1)
1. **CanvasContextProvider** - Foundation context provider
2. **Basic Status Indicator** - Simple connected/disconnected states
3. **Error Boundary** - Graceful error handling
4. **Mobile Detection** - Basic mobile Canvas detection

### Phase 2: Enhanced UX (Week 2)
1. **Content Awareness Display** - Show current Canvas page context
2. **Advanced Status Indicator** - Detailed status with actions
3. **Responsive Adaptations** - Full mobile optimizations
4. **Error Recovery UI** - User-initiated recovery flows

### Phase 3: Advanced Features (Week 3)
1. **Performance Monitoring** - Real-time metrics display
2. **Accessibility Enhancements** - WCAG 2.1 AA compliance
3. **Advanced Mobile Support** - Canvas app specific features
4. **Integration Polish** - Final UX refinements

### Phase 4: Testing & Optimization (Week 4)
1. **Comprehensive Testing** - Unit, integration, visual tests
2. **Performance Optimization** - Bundle size and runtime performance
3. **Cross-Browser Validation** - Compatibility testing
4. **Accessibility Audit** - Manual and automated testing

## Integration Points

### Existing System Enhancements

**Chat System:**
- Add Canvas content awareness to chat context
- Show current page information in chat header
- Enhance AI responses with Canvas page context

**Analytics Dashboard:**
- Display Canvas integration health metrics
- Show content extraction success rates
- Monitor postMessage performance trends

**Cross-Course Intelligence:**
- Enhance with real-time Canvas page correlation
- Add Canvas content to prerequisite detection
- Improve knowledge gap identification with current context

### API Integration

**Frontend API Calls:**
```typescript
// Canvas content extraction
POST /api/canvas/content/extract
GET /api/canvas/content/references/:studentId
PUT /api/canvas/context/update

// Integration health monitoring
GET /api/canvas/integration/health
GET /api/canvas/integration/metrics

// Error reporting and recovery
POST /api/canvas/integration/error-report
POST /api/canvas/integration/retry
```

**WebSocket Events:**
```typescript
// Real-time Canvas integration updates
'canvas.content.extracted'
'canvas.context.updated'
'canvas.integration.health-changed'
'canvas.error.recovery-needed'
```

This comprehensive frontend specification ensures that the Canvas postMessage integration provides excellent user experience with proper feedback, error handling, and accessibility support while maintaining compatibility with the existing Atomic Guide architecture.