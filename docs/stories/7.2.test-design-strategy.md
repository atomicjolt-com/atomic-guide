# Story 7.2: Deep Linking Configuration Interface - Test Design Strategy

**Quinn, QA Test Architect**
**Document Version:** 1.0
**Date:** 2025-09-16
**Story Reference:** [Story 7.2](./7.2.story.md)

## Executive Summary

This test design strategy provides comprehensive test coverage for Story 7.2 (Deep Linking Configuration Interface), focusing on the instructor workflow for embedding AI-powered assessment checkpoints in Canvas assignments. The strategy addresses LTI 1.3 Deep Linking 2.0 compliance, Canvas integration complexity, AI quality validation, and security requirements while building on Story 7.1 foundations.

**Key Testing Priorities:**
1. **LTI Deep Linking 2.0 Compliance** - Full specification compliance with Canvas compatibility
2. **Security Validation** - JWT validation, session security, content sanitization
3. **Canvas Integration** - Multi-environment compatibility and Rich Content Editor integration
4. **AI Quality Assurance** - Pedagogical validation and content appropriateness
5. **Performance Optimization** - Configuration interface responsiveness and scalability

## 1. Test Strategy Overview

### 1.1 Testing Philosophy

**Risk-Based Testing Approach:**
- **HIGH RISK**: LTI compliance, Canvas compatibility, security vulnerabilities
- **MEDIUM RISK**: AI quality validation, performance optimization, instructor workflow
- **LOW RISK**: UI/UX consistency, configuration persistence, error messaging

**Test Pyramid Distribution:**
- **Unit Tests (60%)**: Component logic, service functions, validation rules
- **Integration Tests (25%)**: LTI workflows, Canvas API integration, AI services
- **End-to-End Tests (10%)**: Complete instructor configuration workflows
- **Security Tests (5%)**: Penetration testing, vulnerability assessment

### 1.2 Test Infrastructure Foundation

**Leveraging Story 7.1 Infrastructure:**
- Vitest with Workers pool for Cloudflare Workers environment
- Mock frameworks for Canvas API and LTI platform simulation
- Security testing harness for postMessage and JWT validation
- Test data factories for Canvas content and assessment configurations

**New Testing Infrastructure Requirements:**
- LTI Deep Linking 2.0 compliance validation framework
- Canvas environment compatibility matrix testing
- AI content quality validation pipeline
- Performance load testing for configuration workflows

## 2. Test Coverage Requirements

### 2.1 Functional Coverage (Target: 95%)

**LTI Deep Linking Infrastructure (AC 1-4):**
- JWT validation with Canvas platform keys
- Content item generation and signing
- Deep linking session management
- Error handling and fallback scenarios

**Configuration Interface (AC 5-8):**
- Canvas assignment context extraction
- Assessment checkpoint placement selection
- Real-time preview generation
- Configuration validation and persistence

**AI Assessment Generation (AC 9-12):**
- Question generation quality and relevance
- Instructor review and approval workflow
- Template library management
- Bulk assessment configuration

**Canvas Integration (AC 13-20):**
- Assignment synchronization
- Grade passback configuration
- Mobile compatibility
- Rich Content Editor integration

### 2.2 Security Coverage (Target: 100%)

**Authentication and Authorization:**
- LTI 1.3 JWT signature verification
- Instructor role and permission validation
- Session security and timeout management
- CSRF protection and anti-tampering measures

**Data Validation and Sanitization:**
- Canvas content extraction validation
- AI-generated content sanitization
- Configuration data encryption at rest
- Injection attack prevention

### 2.3 Performance Coverage (Target: 90%)

**Response Time Requirements:**
- Configuration modal load: <3 seconds
- AI question generation: <10 seconds
- Deep linking request processing: <2 seconds
- Canvas integration success rate: >95%

**Scalability Testing:**
- Concurrent instructor configuration sessions
- Canvas API rate limiting compliance
- Configuration data storage and retrieval
- Real-time session state management

## 3. Test Scenarios by Acceptance Criteria

### 3.1 LTI Deep Linking 2.0 Implementation (AC 1-4)

#### Test Scenario 3.1.1: Deep Linking Request Processing
```typescript
describe('Deep Linking Request Processing', () => {
  test('validates Canvas deep linking JWT with correct signature', async () => {
    // Arrange: Mock Canvas platform JWT with valid signature
    const canvasJWT = createMockCanvasDeepLinkingJWT({
      iss: 'https://atomicjolt.instructure.com',
      aud: 'atomic-guide-client-id',
      'https://purl.imsglobal.org/spec/lti/claim/message_type': 'LtiDeepLinkingRequest'
    });

    // Act: Process deep linking request
    const result = await deepLinkingHandler.processRequest(canvasJWT);

    // Assert: Valid session created
    expect(result.sessionId).toBeDefined();
    expect(result.state).toBe('active');
    expect(result.expiresAt).toBeGreaterThan(Date.now());
  });

  test('rejects malformed deep linking JWT', async () => {
    // Arrange: Invalid JWT structure
    const invalidJWT = 'invalid.jwt.token';

    // Act & Assert: Should throw validation error
    await expect(deepLinkingHandler.processRequest(invalidJWT))
      .rejects.toThrow('Invalid LTI Deep Linking JWT');
  });

  test('enforces session timeout and cleanup', async () => {
    // Arrange: Create session with short timeout
    const session = await createDeepLinkingSession({ timeout: 1000 });

    // Act: Wait for timeout + cleanup
    await sleep(1200);
    await deepLinkingSessionCleanup.run();

    // Assert: Session marked as expired
    const expiredSession = await getSession(session.id);
    expect(expiredSession.state).toBe('expired');
  });
});
```

#### Test Scenario 3.1.2: Content Item Generation
```typescript
describe('Content Item Generation', () => {
  test('creates LTI-compliant assessment content items', () => {
    // Arrange: Valid assessment configuration
    const assessmentConfig = createMockAssessmentConfig({
      title: 'React Fundamentals Quiz',
      points: 100,
      checkpoints: 3
    });

    // Act: Generate content items
    const contentItems = contentItemService.generateAssessmentItems(assessmentConfig);

    // Assert: LTI Deep Linking 2.0 compliance
    expect(contentItems).toHaveLength(3);
    contentItems.forEach(item => {
      expect(item).toMatchSchema(LTI_CONTENT_ITEM_SCHEMA);
      expect(item.lineItem).toBeDefined();
      expect(item.lineItem.scoreMaximum).toBe(100);
      expect(item.custom.assessment_configuration_id).toBeDefined();
    });
  });

  test('validates content item security before Canvas delivery', () => {
    // Arrange: Assessment with potential XSS content
    const maliciousConfig = createMockAssessmentConfig({
      title: '<script>alert("xss")</script>Malicious Quiz',
      description: 'Normal description<iframe src="evil.com"></iframe>'
    });

    // Act: Generate and validate content items
    const contentItems = contentItemService.generateAssessmentItems(maliciousConfig);

    // Assert: Malicious content sanitized
    expect(contentItems[0].title).toBe('Malicious Quiz');
    expect(contentItems[0].text).not.toContain('<iframe>');
  });
});
```

### 3.2 Instructor Configuration Interface (AC 5-8)

#### Test Scenario 3.2.1: Canvas Assignment Context Loading
```typescript
describe('Canvas Assignment Context', () => {
  test('extracts assignment metadata with 95% accuracy', async () => {
    // Arrange: Mock Canvas assignment with rich content
    const canvasAssignment = createMockCanvasAssignment({
      title: 'JavaScript Fundamentals',
      description: '<p>Learn JavaScript basics</p><h2>Learning Objectives</h2><ul><li>Variables</li><li>Functions</li></ul>',
      dueDate: '2025-10-01T23:59:59Z',
      points: 100
    });

    // Act: Extract assignment context
    const context = await canvasContextService.extractAssignmentContext(canvasAssignment);

    // Assert: Accurate extraction
    expect(context.title).toBe('JavaScript Fundamentals');
    expect(context.learningObjectives).toContain('Variables');
    expect(context.learningObjectives).toContain('Functions');
    expect(context.contentStructure.sections).toHaveLength(2);
  });

  test('handles Canvas assignment updates in real-time', async () => {
    // Arrange: Initial assignment context
    const initialContext = await setupCanvasAssignmentContext();

    // Act: Simulate Canvas assignment update
    const updatedAssignment = {
      ...initialContext.assignment,
      title: 'Updated JavaScript Fundamentals',
      points: 150
    };
    await canvasContextService.updateAssignmentContext(updatedAssignment);

    // Assert: Context synchronized
    const currentContext = await canvasContextService.getCurrentContext();
    expect(currentContext.title).toBe('Updated JavaScript Fundamentals');
    expect(currentContext.maxPoints).toBe(150);
  });
});
```

#### Test Scenario 3.2.2: Assessment Checkpoint Placement
```typescript
describe('Assessment Checkpoint Placement', () => {
  test('allows precise content location selection', async () => {
    // Arrange: Canvas content with multiple sections
    const contentSections = createMockCanvasContent([
      { type: 'paragraph', id: 'intro', text: 'Introduction to React' },
      { type: 'heading', id: 'components', text: 'Components' },
      { type: 'paragraph', id: 'component-desc', text: 'React components...' }
    ]);

    // Act: Place assessment checkpoints
    const placements = await placementSelector.selectCheckpointLocations([
      { contentId: 'intro', position: 'after' },
      { contentId: 'component-desc', position: 'inline' }
    ]);

    // Assert: Precise placement
    expect(placements).toHaveLength(2);
    expect(placements[0].selector).toBe('#intro + .assessment-checkpoint');
    expect(placements[1].coordinates).toBeDefined();
  });

  test('validates checkpoint placement conflicts', async () => {
    // Arrange: Overlapping checkpoint placements
    const conflictingPlacements = [
      { contentId: 'section1', position: 'after' },
      { contentId: 'section1', position: 'after' } // Duplicate
    ];

    // Act & Assert: Should detect conflict
    await expect(placementSelector.validatePlacements(conflictingPlacements))
      .rejects.toThrow('Conflicting checkpoint placements detected');
  });
});
```

### 3.3 AI-Powered Assessment Generation (AC 9-12)

#### Test Scenario 3.3.1: AI Question Quality Validation
```typescript
describe('AI Question Generation Quality', () => {
  test('generates pedagogically sound questions with 85% relevance', async () => {
    // Arrange: Canvas content about React components
    const canvasContent = createMockCanvasContent({
      topic: 'React Components',
      text: 'React components are reusable UI elements that accept props and return JSX...',
      learningObjectives: ['Understand component structure', 'Use props effectively']
    });

    // Act: Generate AI questions
    const questions = await aiQuestionService.generateQuestions(canvasContent, {
      count: 5,
      difficulty: 'intermediate',
      type: 'comprehension'
    });

    // Assert: Quality validation
    expect(questions).toHaveLength(5);
    questions.forEach(question => {
      expect(question.relevanceScore).toBeGreaterThan(0.85);
      expect(question.bloomsLevel).toContain('understand');
      expect(question.text).toContain('component');
    });
  });

  test('validates content appropriateness for educational contexts', async () => {
    // Arrange: Content analysis that might generate inappropriate questions
    const edgeContent = createMockCanvasContent({
      topic: 'Historical Events',
      text: 'Discussion of sensitive historical topics...'
    });

    // Act: Generate questions with appropriateness screening
    const questions = await aiQuestionService.generateQuestions(edgeContent);

    // Assert: All questions pass appropriateness screening
    questions.forEach(question => {
      expect(question.appropriatenessScore).toBeGreaterThan(0.9);
      expect(question.culturalSensitivityFlag).toBe(false);
    });
  });
});
```

#### Test Scenario 3.3.2: Instructor Review Workflow
```typescript
describe('Instructor Review Workflow', () => {
  test('enables efficient question review and editing', async () => {
    // Arrange: AI-generated questions pending review
    const pendingQuestions = await createMockPendingQuestions(10);

    // Act: Instructor reviews and edits questions
    const startTime = Date.now();
    const reviewedQuestions = await instructorReviewService.processReviewBatch(
      pendingQuestions,
      [
        { questionId: 'q1', action: 'approve' },
        { questionId: 'q2', action: 'edit', changes: { text: 'Improved question text' } },
        { questionId: 'q3', action: 'reject', reason: 'Not relevant' }
      ]
    );
    const reviewTime = Date.now() - startTime;

    // Assert: Efficient workflow (target: <5 minutes for 10 questions)
    expect(reviewTime).toBeLessThan(300000); // 5 minutes
    expect(reviewedQuestions.approved).toHaveLength(1);
    expect(reviewedQuestions.edited).toHaveLength(1);
    expect(reviewedQuestions.rejected).toHaveLength(1);
  });

  test('tracks AI improvement through instructor feedback', async () => {
    // Arrange: Initial AI generation with feedback loop
    const questions = await aiQuestionService.generateQuestions(mockContent);

    // Act: Provide instructor feedback
    await instructorFeedbackService.submitFeedback(questions[0].id, {
      quality: 3,
      relevance: 4,
      clarity: 5,
      suggestions: 'More specific examples needed'
    });

    // Assert: Feedback captured for AI improvement
    const feedback = await getFeedbackForQuestion(questions[0].id);
    expect(feedback.averageQuality).toBe(3);
    expect(feedback.improvementSuggestions).toContain('specific examples');
  });
});
```

### 3.4 Canvas Deep Linking Integration (AC 17-20)

#### Test Scenario 3.4.1: Canvas Environment Compatibility
```typescript
describe('Canvas Environment Compatibility', () => {
  test('handles Canvas Cloud environment deep linking', async () => {
    // Arrange: Canvas Cloud configuration
    const canvasCloudConfig = createMockCanvasEnvironment({
      type: 'cloud',
      version: '2025.1.0',
      baseUrl: 'https://institution.instructure.com'
    });

    // Act: Process deep linking in Canvas Cloud
    const result = await deepLinkingService.processCanvasEnvironment(canvasCloudConfig);

    // Assert: Successful integration
    expect(result.success).toBe(true);
    expect(result.capabilities.richContentEditor).toBe(true);
    expect(result.capabilities.mobileApp).toBe(true);
  });

  test('adapts to Canvas self-hosted customizations', async () => {
    // Arrange: Self-hosted Canvas with customizations
    const selfHostedConfig = createMockCanvasEnvironment({
      type: 'self-hosted',
      version: '2024.12.0',
      customizations: ['custom-auth', 'modified-deep-linking']
    });

    // Act: Detect and adapt to customizations
    const adaptations = await canvasAdaptationService.analyzeEnvironment(selfHostedConfig);

    // Assert: Proper adaptation
    expect(adaptations.authMethod).toBe('custom-auth');
    expect(adaptations.deepLinkingVariations).toContain('modified-deep-linking');
  });
});
```

#### Test Scenario 3.4.2: Grade Passback Integration
```typescript
describe('Grade Passback Integration', () => {
  test('successfully passes back assessment scores to Canvas gradebook', async () => {
    // Arrange: Completed assessment with score
    const assessmentResult = createMockAssessmentResult({
      studentId: 'student123',
      assessmentId: 'assessment456',
      score: 85,
      maxScore: 100,
      completedAt: new Date()
    });

    // Act: Pass back grade to Canvas
    const gradePassback = await gradePassbackService.submitGrade(assessmentResult);

    // Assert: Successful grade passback
    expect(gradePassback.success).toBe(true);
    expect(gradePassback.canvasGradeId).toBeDefined();
    expect(gradePassback.scorePosted).toBe(85);
  });

  test('handles Canvas gradebook conflicts gracefully', async () => {
    // Arrange: Grade passback with existing Canvas grade
    const conflictingGrade = createMockGradeConflict({
      canvasScore: 90,
      assessmentScore: 85,
      source: 'manual'
    });

    // Act: Attempt grade passback with conflict
    const result = await gradePassbackService.handleGradeConflict(conflictingGrade);

    // Assert: Conflict resolution
    expect(result.conflictResolution).toBe('instructor-review-required');
    expect(result.notificationSent).toBe(true);
  });
});
```

## 4. Canvas Deep Linking Test Matrix

### 4.1 Canvas Environment Compatibility Matrix

| Canvas Environment | Version Range | Deep Linking Support | Rich Content Editor | Mobile App | Test Priority |
|-------------------|---------------|---------------------|-------------------|------------|---------------|
| Canvas Cloud | 2024.1+ | Full LTI 1.3 DL 2.0 | Yes | Yes | HIGH |
| Canvas Cloud | 2023.x | Limited DL support | Yes | Partial | MEDIUM |
| Self-Hosted | 2024.1+ | Configuration dependent | Variable | Variable | HIGH |
| Self-Hosted | 2023.x | Legacy LTI support | Limited | No | LOW |
| Canvas Mobile | iOS/Android | Limited instructor tools | N/A | Yes | MEDIUM |

### 4.2 Browser Compatibility Matrix

| Browser | Version | Canvas RCE | Deep Linking | Mobile Canvas | Test Coverage |
|---------|---------|------------|--------------|---------------|---------------|
| Chrome | 120+ | Full support | Yes | Yes | HIGH |
| Firefox | 115+ | Full support | Yes | Limited | MEDIUM |
| Safari | 17+ | Full support | Yes | Yes | HIGH |
| Edge | 120+ | Full support | Yes | Limited | MEDIUM |
| Mobile Safari | iOS 17+ | Limited | N/A | Yes | MEDIUM |
| Chrome Mobile | Android 13+ | Limited | N/A | Yes | MEDIUM |

### 4.3 LTI Platform Variation Tests

```typescript
describe('LTI Platform Variations', () => {
  const platformConfigurations = [
    {
      name: 'Canvas Cloud Standard',
      issuer: 'https://canvas.instructure.com',
      authEndpoint: 'https://canvas.instructure.com/api/lti/authorize_redirect',
      deepLinkingClaims: ['ltiResourceLink', 'html']
    },
    {
      name: 'Canvas Self-Hosted',
      issuer: 'https://custom.university.edu',
      authEndpoint: 'https://custom.university.edu/lti/authorize',
      deepLinkingClaims: ['ltiResourceLink']
    }
  ];

  platformConfigurations.forEach(config => {
    test(`handles ${config.name} deep linking configuration`, async () => {
      // Arrange: Platform-specific configuration
      const platformSetup = await setupLTIPlatform(config);

      // Act: Process deep linking request
      const result = await deepLinkingHandler.processPlatformRequest(platformSetup);

      // Assert: Platform-specific success
      expect(result.success).toBe(true);
      expect(result.contentItemsSupported).toEqual(config.deepLinkingClaims);
    });
  });
});
```

## 5. Integration Tests with Story 7.1 Foundations

### 5.1 Canvas Content Extraction Enhancement

```typescript
describe('Story 7.1 Integration - Content Extraction', () => {
  test('enhances ContentExtractionService for assessment placement analysis', async () => {
    // Arrange: Use Story 7.1 content extraction with deep linking enhancement
    const canvasContent = createMockCanvasPageContent();

    // Act: Extract content with assessment placement analysis
    const enhancedExtraction = await contentExtractionService.extractWithAssessmentAnalysis(canvasContent);

    // Assert: Enhanced analysis includes placement recommendations
    expect(enhancedExtraction.originalContent).toBeDefined(); // Story 7.1 functionality
    expect(enhancedExtraction.assessmentPlacements).toBeDefined(); // Story 7.2 enhancement
    expect(enhancedExtraction.assessmentPlacements.length).toBeGreaterThan(0);
  });
});
```

### 5.2 Security Framework Extension

```typescript
describe('Story 7.1 Integration - Security Framework', () => {
  test('extends PostMessageSecurityService for deep linking JWT validation', async () => {
    // Arrange: Story 7.1 security service with deep linking extension
    const securityService = new PostMessageSecurityService();
    const deepLinkingJWT = createMockDeepLinkingJWT();

    // Act: Validate deep linking JWT using enhanced security framework
    const validation = await securityService.validateDeepLinkingJWT(deepLinkingJWT);

    // Assert: Both Story 7.1 and 7.2 security requirements met
    expect(validation.hmacValid).toBe(true); // Story 7.1 functionality
    expect(validation.jwtSignatureValid).toBe(true); // Story 7.2 enhancement
    expect(validation.deepLinkingClaimsValid).toBe(true); // Story 7.2 specific
  });
});
```

### 5.3 Canvas Context Tracker Enhancement

```typescript
describe('Story 7.1 Integration - Canvas Context Tracking', () => {
  test('extends CanvasContextTracker for deep linking session management', async () => {
    // Arrange: Story 7.1 context tracker with deep linking enhancement
    const contextTracker = new CanvasContextTracker();
    const deepLinkingSession = createMockDeepLinkingSession();

    // Act: Track deep linking configuration session
    await contextTracker.trackDeepLinkingSession(deepLinkingSession);

    // Assert: Both content context and configuration session tracked
    const sessionState = await contextTracker.getSessionState();
    expect(sessionState.canvasContext).toBeDefined(); // Story 7.1 functionality
    expect(sessionState.deepLinkingSession).toBeDefined(); // Story 7.2 enhancement
  });
});
```

## 6. Performance Test Scenarios

### 6.1 Configuration Interface Performance

```typescript
describe('Configuration Interface Performance', () => {
  test('loads configuration modal within 3 seconds', async () => {
    // Arrange: Large Canvas assignment with complex content
    const largeAssignment = createMockLargeCanvasAssignment({
      contentSections: 50,
      mediaElements: 20,
      learningObjectives: 15
    });

    // Act: Load configuration modal
    const startTime = performance.now();
    await configurationModal.load(largeAssignment);
    const loadTime = performance.now() - startTime;

    // Assert: Performance target met
    expect(loadTime).toBeLessThan(3000); // 3 seconds
  });

  test('handles concurrent instructor configuration sessions', async () => {
    // Arrange: Multiple instructors configuring simultaneously
    const concurrentInstructors = Array.from({ length: 10 }, (_, i) =>
      createMockInstructorSession(`instructor${i}`)
    );

    // Act: Start concurrent configuration sessions
    const startTime = performance.now();
    const sessions = await Promise.all(
      concurrentInstructors.map(instructor =>
        configurationService.startSession(instructor)
      )
    );
    const totalTime = performance.now() - startTime;

    // Assert: All sessions started successfully within performance bounds
    expect(sessions).toHaveLength(10);
    expect(sessions.every(session => session.success)).toBe(true);
    expect(totalTime).toBeLessThan(5000); // 5 seconds for 10 concurrent sessions
  });
});
```

### 6.2 AI Generation Performance

```typescript
describe('AI Generation Performance', () => {
  test('generates assessment questions within 10 seconds', async () => {
    // Arrange: Complex Canvas content for question generation
    const complexContent = createMockComplexCanvasContent({
      wordCount: 5000,
      topics: ['React', 'JavaScript', 'Web Development'],
      codeExamples: 10
    });

    // Act: Generate AI questions
    const startTime = performance.now();
    const questions = await aiQuestionService.generateQuestions(complexContent, {
      count: 10,
      difficulty: 'advanced'
    });
    const generationTime = performance.now() - startTime;

    // Assert: Performance and quality targets met
    expect(generationTime).toBeLessThan(10000); // 10 seconds
    expect(questions).toHaveLength(10);
    expect(questions.every(q => q.relevanceScore > 0.85)).toBe(true);
  });
});
```

### 6.3 Canvas API Integration Performance

```typescript
describe('Canvas API Integration Performance', () => {
  test('respects Canvas API rate limits while maintaining responsiveness', async () => {
    // Arrange: Canvas API with rate limiting (typical: 700 requests/hour)
    const canvasAPI = createMockCanvasAPIWithRateLimit({
      requestsPerHour: 700,
      burstLimit: 10
    });

    // Act: Perform multiple Canvas operations
    const operations = [
      'getAssignmentContent',
      'getCourseLearningObjectives',
      'getCourseModules',
      'getGradebookColumns'
    ];

    const startTime = performance.now();
    const results = await Promise.all(
      operations.map(op => canvasIntegrationService[op]())
    );
    const totalTime = performance.now() - startTime;

    // Assert: All operations completed without rate limit violations
    expect(results.every(result => result.success)).toBe(true);
    expect(canvasAPI.rateLimitViolations).toBe(0);
    expect(totalTime).toBeLessThan(5000); // Reasonable response time
  });
});
```

## 7. Security Test Cases

### 7.1 Authentication and Authorization Security

```typescript
describe('Authentication and Authorization Security', () => {
  test('validates LTI 1.3 JWT signatures with Canvas platform keys', async () => {
    // Arrange: Mock Canvas platform with valid and invalid JWTs
    const validJWT = createValidCanvasJWT();
    const tamperedJWT = tamperWithJWT(validJWT);
    const expiredJWT = createExpiredCanvasJWT();

    // Act & Assert: Valid JWT passes
    const validResult = await jwtValidationService.validateCanvasJWT(validJWT);
    expect(validResult.valid).toBe(true);

    // Act & Assert: Tampered JWT fails
    await expect(jwtValidationService.validateCanvasJWT(tamperedJWT))
      .rejects.toThrow('JWT signature validation failed');

    // Act & Assert: Expired JWT fails
    await expect(jwtValidationService.validateCanvasJWT(expiredJWT))
      .rejects.toThrow('JWT has expired');
  });

  test('enforces instructor role requirements for configuration access', async () => {
    // Arrange: Different user roles attempting configuration access
    const instructor = createMockUser({ role: 'instructor' });
    const student = createMockUser({ role: 'student' });
    const ta = createMockUser({ role: 'ta' });

    // Act & Assert: Instructor has access
    const instructorAccess = await authorizationService.canConfigureAssessments(instructor);
    expect(instructorAccess).toBe(true);

    // Act & Assert: Student denied access
    const studentAccess = await authorizationService.canConfigureAssessments(student);
    expect(studentAccess).toBe(false);

    // Act & Assert: TA access based on permissions
    const taAccess = await authorizationService.canConfigureAssessments(ta);
    expect(taAccess).toBe(false); // Unless specifically granted
  });
});
```

### 7.2 Content Security and Injection Prevention

```typescript
describe('Content Security and Injection Prevention', () => {
  test('sanitizes AI-generated content to prevent XSS attacks', async () => {
    // Arrange: Mock AI service that might generate malicious content
    const maliciousContent = {
      question: 'What is React? <script>alert("xss")</script>',
      explanation: 'React is a library <iframe src="evil.com"></iframe>',
      options: ['Option 1', '<img src=x onerror=alert("xss")>', 'Option 3']
    };

    // Act: Sanitize AI-generated content
    const sanitizedContent = await contentSanitizationService.sanitizeAssessmentContent(maliciousContent);

    // Assert: Malicious content removed
    expect(sanitizedContent.question).toBe('What is React? ');
    expect(sanitizedContent.explanation).not.toContain('<iframe>');
    expect(sanitizedContent.options[1]).not.toContain('onerror');
  });

  test('validates Canvas content items for injection attacks', async () => {
    // Arrange: Malicious content item attempting Canvas injection
    const maliciousContentItem = {
      type: 'ltiResourceLink',
      title: 'Normal Title',
      url: 'javascript:alert("xss")', // Malicious URL
      custom: {
        assessment_config: '{"__proto__": {"isAdmin": true}}' // Prototype pollution
      }
    };

    // Act & Assert: Validation catches malicious content
    await expect(contentItemValidationService.validateContentItem(maliciousContentItem))
      .rejects.toThrow('Invalid URL scheme detected');
  });
});
```

### 7.3 Session Security and CSRF Protection

```typescript
describe('Session Security and CSRF Protection', () => {
  test('enforces session timeouts and secure cleanup', async () => {
    // Arrange: Deep linking session with security configuration
    const session = await createSecureDeepLinkingSession({
      instructorId: 'instructor123',
      timeout: 1800000, // 30 minutes
      csrfToken: generateCSRFToken()
    });

    // Act: Simulate session timeout
    await advanceTime(1800001); // 30 minutes + 1ms
    const sessionStatus = await sessionSecurityService.validateSession(session.id);

    // Assert: Session expired and cleaned up
    expect(sessionStatus.valid).toBe(false);
    expect(sessionStatus.reason).toBe('expired');
  });

  test('protects against CSRF attacks on configuration endpoints', async () => {
    // Arrange: Configuration request without valid CSRF token
    const configurationRequest = {
      sessionId: 'session123',
      assessmentConfig: createMockAssessmentConfig(),
      // Missing or invalid CSRF token
    };

    // Act & Assert: Request rejected due to missing CSRF protection
    await expect(configurationService.updateAssessmentConfig(configurationRequest))
      .rejects.toThrow('CSRF token validation failed');
  });
});
```

## 8. Risk-Based Testing Priorities

### 8.1 Critical Risk Areas (Priority 1)

**LTI Compliance and Canvas Integration:**
- **Risk**: Canvas rejects content items due to non-compliance
- **Impact**: Complete feature failure, instructor cannot embed assessments
- **Test Priority**: HIGH
- **Mitigation**: Comprehensive LTI Deep Linking 2.0 compliance test suite

**Security Vulnerabilities:**
- **Risk**: Authentication bypass, XSS attacks, session hijacking
- **Impact**: Platform security compromise, data breach
- **Test Priority**: CRITICAL
- **Mitigation**: Penetration testing, security audit, automated vulnerability scanning

**Canvas Environment Compatibility:**
- **Risk**: Deep linking fails in specific Canvas configurations
- **Impact**: Feature unavailable for affected institutions
- **Test Priority**: HIGH
- **Mitigation**: Canvas environment compatibility matrix testing

### 8.2 Medium Risk Areas (Priority 2)

**AI Content Quality:**
- **Risk**: Poor quality or inappropriate AI-generated questions
- **Impact**: Reduced instructor adoption, pedagogical concerns
- **Test Priority**: MEDIUM
- **Mitigation**: Quality validation pipeline, instructor feedback loop

**Performance Degradation:**
- **Risk**: Slow configuration interface, AI generation timeouts
- **Impact**: Poor user experience, instructor frustration
- **Test Priority**: MEDIUM
- **Mitigation**: Performance load testing, optimization monitoring

### 8.3 Low Risk Areas (Priority 3)

**UI/UX Consistency:**
- **Risk**: Interface inconsistencies, minor usability issues
- **Impact**: Minor user experience degradation
- **Test Priority**: LOW
- **Mitigation**: UI component testing, accessibility validation

**Configuration Data Persistence:**
- **Risk**: Configuration data loss, sync issues
- **Impact**: Instructor rework, minor inconvenience
- **Test Priority**: LOW
- **Mitigation**: Data integrity testing, backup validation

## 9. Test Environment Strategy

### 9.1 Test Environment Matrix

| Environment | Purpose | Canvas Version | LTI Setup | Test Data | Priority |
|-------------|---------|----------------|-----------|-----------|----------|
| Unit Test | Component/Service Testing | Mocked | Mocked | Synthetic | HIGH |
| Integration | Canvas API Integration | Cloud Latest | Real Platform | Controlled | HIGH |
| Staging | End-to-End Workflows | Cloud 2024.1 | Full LTI 1.3 | Realistic | MEDIUM |
| Security | Penetration Testing | Multiple | Hardened | Attack Vectors | HIGH |
| Performance | Load Testing | Cloud Latest | Optimized | Large Scale | MEDIUM |

### 9.2 Canvas Test Environment Configuration

```typescript
// Canvas Test Environment Setup
const canvasTestEnvironments = {
  development: {
    baseUrl: 'https://atomicjolt-dev.instructure.com',
    clientId: 'dev-client-id',
    deploymentId: 'dev-deployment',
    sharedSecret: process.env.CANVAS_DEV_SECRET,
    deepLinkingEnabled: true
  },
  staging: {
    baseUrl: 'https://atomicjolt-staging.instructure.com',
    clientId: 'staging-client-id',
    deploymentId: 'staging-deployment',
    sharedSecret: process.env.CANVAS_STAGING_SECRET,
    deepLinkingEnabled: true
  },
  production: {
    baseUrl: 'https://atomicjolt.instructure.com',
    clientId: 'prod-client-id',
    deploymentId: 'prod-deployment',
    sharedSecret: process.env.CANVAS_PROD_SECRET,
    deepLinkingEnabled: true
  }
};
```

### 9.3 Test Data Management

```typescript
describe('Test Data Management', () => {
  beforeEach(async () => {
    // Create consistent test data across environments
    await testDataFactory.createInstructorTestData({
      instructorCount: 5,
      coursesPerInstructor: 3,
      assignmentsPerCourse: 10
    });

    await testDataFactory.createCanvasContentData({
      contentVariations: ['text-heavy', 'media-rich', 'code-examples'],
      complexityLevels: ['simple', 'moderate', 'complex']
    });
  });

  afterEach(async () => {
    // Clean up test data to prevent interference
    await testDataFactory.cleanupTestData();
  });
});
```

## 10. Test Execution Strategy

### 10.1 Continuous Integration Pipeline

```yaml
# .github/workflows/story-7.2-tests.yml
name: Story 7.2 - Deep Linking Configuration Tests

on:
  pull_request:
    paths:
      - 'src/features/deep-linking/**'
      - 'src/features/assessment/**'
      - 'tests/integration/deep-linking/**'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Unit Tests
        run: npm run test:unit -- src/features/deep-linking
      - name: Upload Coverage
        uses: codecov/codecov-action@v3

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - name: Setup Canvas Test Environment
        run: npm run test:setup:canvas
      - name: Run Integration Tests
        run: npm run test:integration -- deep-linking
        env:
          CANVAS_TEST_URL: ${{ secrets.CANVAS_TEST_URL }}
          CANVAS_TEST_TOKEN: ${{ secrets.CANVAS_TEST_TOKEN }}

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
      - uses: actions/checkout@v4
      - name: Run Security Audit
        run: npm run test:security -- deep-linking
      - name: LTI Compliance Check
        run: npm run test:lti-compliance

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
      - name: Run Performance Tests
        run: npm run test:performance -- deep-linking
      - name: Upload Performance Report
        uses: actions/upload-artifact@v3
```

### 10.2 Test Automation Strategy

**Automated Test Categories:**
- **Unit Tests**: Run on every commit (target: <2 minutes)
- **Integration Tests**: Run on pull requests (target: <10 minutes)
- **Security Tests**: Run on pull requests and nightly (target: <5 minutes)
- **Performance Tests**: Run on release candidates (target: <30 minutes)
- **End-to-End Tests**: Run on staging deployment (target: <15 minutes)

**Manual Test Categories:**
- **Canvas Environment Compatibility**: Weekly on different Canvas versions
- **Instructor Workflow Validation**: Before major releases
- **Accessibility Testing**: Before major releases
- **Cross-Browser Testing**: Before major releases

### 10.3 Test Reporting and Monitoring

```typescript
// Test reporting configuration
const testReporting = {
  coverage: {
    target: {
      statements: 95,
      branches: 90,
      functions: 95,
      lines: 95
    },
    excludePatterns: [
      'src/**/*.test.ts',
      'src/**/__tests__/**',
      'src/**/test-utils/**'
    ]
  },
  performance: {
    budgets: {
      configurationModalLoad: 3000, // 3 seconds
      aiQuestionGeneration: 10000, // 10 seconds
      deepLinkingProcessing: 2000 // 2 seconds
    },
    monitoring: {
      alertThreshold: 1.5, // 150% of budget
      reportingInterval: 'daily'
    }
  },
  security: {
    vulnerabilityScanning: 'continuous',
    complianceChecks: ['LTI 1.3', 'Canvas API', 'FERPA'],
    reportingLevel: 'all-findings'
  }
};
```

## 11. Success Criteria and Quality Gates

### 11.1 Test Coverage Quality Gates

**Unit Test Coverage:**
- **Minimum**: 80% statement coverage
- **Target**: 95% statement coverage
- **Critical Paths**: 100% coverage for security and LTI compliance code

**Integration Test Coverage:**
- **Canvas Integration**: 100% of Canvas API endpoints tested
- **LTI Workflows**: 100% of deep linking scenarios covered
- **Error Scenarios**: 90% of error conditions tested

**End-to-End Test Coverage:**
- **Happy Path**: 100% of instructor configuration workflows
- **Edge Cases**: 80% of edge case scenarios
- **Canvas Environments**: 100% of supported Canvas configurations

### 11.2 Performance Quality Gates

| Metric | Target | Threshold | Action |
|--------|---------|-----------|---------|
| Configuration Modal Load | <3 seconds | 4.5 seconds | Fail build |
| AI Question Generation | <10 seconds | 15 seconds | Fail build |
| Deep Linking Processing | <2 seconds | 3 seconds | Fail build |
| Canvas Integration Success Rate | >95% | <90% | Fail build |
| Concurrent User Support | 50 users | 30 users | Performance warning |

### 11.3 Security Quality Gates

**Authentication Security:**
- 100% JWT validation coverage
- 0 authentication bypass vulnerabilities
- 100% role-based access control enforcement

**Content Security:**
- 100% input sanitization coverage
- 0 XSS vulnerabilities in generated content
- 100% CSRF protection on configuration endpoints

**Session Security:**
- 100% session timeout enforcement
- 0 session hijacking vulnerabilities
- 100% secure session cleanup

### 11.4 LTI Compliance Quality Gates

**Deep Linking 2.0 Compliance:**
- 100% specification compliance for content item generation
- 100% Canvas platform compatibility for supported versions
- 100% grade passback functionality for assessment integration

**Platform Integration:**
- 100% success rate for Canvas Cloud integration
- 90% success rate for Canvas self-hosted integration
- 100% mobile compatibility for supported Canvas mobile apps

## 12. Test Maintenance and Evolution

### 12.1 Test Maintenance Strategy

**Regular Maintenance Activities:**
- **Weekly**: Update Canvas API mock responses for version changes
- **Monthly**: Review and update Canvas environment compatibility matrix
- **Quarterly**: Security test updates for new vulnerability patterns
- **Annually**: Complete LTI specification compliance review

**Test Data Maintenance:**
- **Synthetic Data Refresh**: Monthly update of test assessment configurations
- **Canvas Content Updates**: Quarterly refresh of realistic Canvas content examples
- **Performance Baseline Updates**: Bi-annual review of performance targets

### 12.2 Test Evolution Planning

**Short-term Evolution (1-3 months):**
- Enhanced AI quality validation metrics
- Additional Canvas environment compatibility tests
- Expanded security penetration testing

**Medium-term Evolution (3-6 months):**
- Automated Canvas version compatibility testing
- Advanced performance regression detection
- Integration with Canvas partnership testing

**Long-term Evolution (6+ months):**
- Multi-LMS platform testing expansion
- Advanced AI assessment quality machine learning
- Comprehensive accessibility testing automation

## Conclusion

This comprehensive test design strategy for Story 7.2 provides thorough coverage of the Deep Linking Configuration Interface while building on the solid foundations established in Story 7.1. The strategy addresses the complex Canvas integration requirements, LTI compliance mandates, security considerations, and performance optimization needs.

**Key Success Factors:**
1. **Rigorous LTI Compliance Testing** - Ensures Canvas compatibility across environments
2. **Comprehensive Security Validation** - Protects against authentication and content injection vulnerabilities
3. **Performance-Driven Quality Gates** - Maintains instructor experience standards
4. **Risk-Based Test Prioritization** - Focuses effort on highest-impact areas
5. **Canvas Environment Compatibility** - Supports diverse institutional Canvas configurations

**Expected Outcomes:**
- **95%+ Canvas Integration Success Rate** - Reliable instructor experience across Canvas environments
- **<5 minute Assessment Configuration Time** - Dramatic improvement in instructor efficiency
- **Zero Critical Security Vulnerabilities** - Maintained platform security and institutional trust
- **100% LTI Deep Linking 2.0 Compliance** - Future-proof Canvas integration foundation

This test strategy positions Story 7.2 for successful delivery of the instructor configuration workflow that enables Story 7.3's student-facing AI assessment system while maintaining the highest standards of security, performance, and Canvas integration reliability.